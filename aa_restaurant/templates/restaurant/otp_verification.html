{% extends "restaurant/base.html" %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <h1 class="h4 mb-2">OTP Verification</h1>
                        <p class="text-muted mb-3">
                            Enter the 6-digit OTP sent to your device to complete the payment.
                        </p>

                        <div class="mb-3">
                            <input type="text"
                                   class="form-control text-center fs-4"
                                   id="otpInput"
                                   maxlength="6"
                                   autocomplete="one-time-code"
                                   inputmode="numeric"
                                   placeholder="••••••">
                        </div>

                        <!-- ✅ Submit Button -->
                        <button type="button" class="btn btn-primary w-100 mb-2" id="submitOtpButton">
                            Submit OTP
                        </button>

                        <p class="small text-muted mb-2">
                            Time remaining: <span id="otpTimer">10:00</span>
                        </p>

                        <p class="small text-muted mb-3">
                            Attempts: <span id="otpAttempts">0</span> / 3
                        </p>

                        <button type="button" class="btn btn-outline-primary w-100" id="resendOtpButton">
                            Resend OTP
                        </button>

                        <div id="otpError" class="text-danger small mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var input = document.getElementById("otpInput");
        var timerEl = document.getElementById("otpTimer");
        var attemptsEl = document.getElementById("otpAttempts");
        var resendButton = document.getElementById("resendOtpButton");
        var submitBtn = document.getElementById("submitOtpButton");
        var errorEl = document.getElementById("otpError");

        if (!input || !timerEl || !attemptsEl || !resendButton || !errorEl || !submitBtn) {
            return;
        }

        var maxAttempts = 3;
        var attempts = 0;
        var remainingSeconds = 600;
        var timerId = null;

        function updateTimerDisplay() {
            var minutes = Math.floor(remainingSeconds / 60);
            var seconds = remainingSeconds % 60;
            timerEl.textContent =
                String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
        }

        function startTimer() {
            if (timerId) clearInterval(timerId);

            remainingSeconds = 600;
            updateTimerDisplay();

            timerId = setInterval(function () {
                remainingSeconds -= 1;

                if (remainingSeconds <= 0) {
                    clearInterval(timerId);
                    timerId = null;
                    window.location.href = "/payment/failed/";
                    return;
                }

                updateTimerDisplay();
            }, 1000);
        }

        function generateAndStoreOtp() {
            var otp = Math.floor(100000 + Math.random() * 900000).toString();
            localStorage.setItem("aaPaymentOTP", otp);
            console.log("Resent OTP:", otp);
        }

        function verifyOtp(value) {
            var stored = localStorage.getItem("aaPaymentOTP") || "";

            if (!stored) {
                errorEl.textContent = "OTP expired / not available. Please resend.";
                return;
            }

            if (value === stored) {
                window.location.href = "/place-order/";
                return;
            }

            attempts += 1;
            attemptsEl.textContent = String(attempts);
            errorEl.textContent = "Incorrect OTP. Please try again.";

            if (attempts >= maxAttempts) {
                window.location.href = "/payment/failed/";
            }
        }

        // ✅ Only allow numbers
        input.addEventListener("input", function () {
            var value = input.value.replace(/\D/g, "");
            if (value.length > 6) value = value.slice(0, 6);
            input.value = value;
            errorEl.textContent = "";
        });

        // ✅ Submit button click
        submitBtn.addEventListener("click", function () {
            var value = input.value.replace(/\D/g, "");
            if (value.length !== 6) {
                errorEl.textContent = "Please enter a valid 6-digit OTP.";
                return;
            }
            verifyOtp(value);
        });

        // ✅ Resend OTP
        resendButton.addEventListener("click", function () {
            attempts = 0;
            attemptsEl.textContent = "0";
            errorEl.textContent = "";
            input.value = "";
            generateAndStoreOtp();
            startTimer();
        });

        attemptsEl.textContent = "0";
        startTimer();
    });
</script>
{% endblock %}
